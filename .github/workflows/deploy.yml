name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q '^pai-bot/'; then
            echo "bot=true" >> $GITHUB_OUTPUT
          else
            echo "bot=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q '^pai-claude/'; then
            echo "claude=true" >> $GITHUB_OUTPUT
          else
            echo "claude=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q '^ansible/'; then
            echo "ansible=true" >> $GITHUB_OUTPUT
          else
            echo "ansible=false" >> $GITHUB_OUTPUT
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Create vault password file
        run: |
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > ~/.vault_pass_pai
          chmod 600 ~/.vault_pass_pai

      - name: Extract SSH key from vault
        run: |
          uv run ansible-vault decrypt ansible/inventory/group_vars/all/vault.yml \
            --output=/tmp/vault_plain.yml \
            --vault-password-file=~/.vault_pass_pai
          grep -A10 "pai_agent_ssh_private_key:" /tmp/vault_plain.yml | tail -n +2 | sed 's/^  //' > ~/.ssh_key
          chmod 600 ~/.ssh_key
          rm /tmp/vault_plain.yml

      - name: Setup SSH known hosts
        run: |
          mkdir -p ~/.ssh
          SERVER_IP=$(uv run ansible-vault decrypt ansible/inventory/group_vars/all/vault.yml \
            --output=- \
            --vault-password-file=~/.vault_pass_pai | grep 'vault_server_ip:' | sed 's/.*"\(.*\)".*/\1/')
          ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy Claude configuration
        if: steps.changes.outputs.claude == 'true' || steps.changes.outputs.ansible == 'true'
        env:
          PAI_SSH_KEY_FILE: ~/.ssh_key
        run: uv run ansible-playbook ansible/playbooks/deploy-claude.yml

      - name: Deploy Bot
        if: steps.changes.outputs.bot == 'true' || steps.changes.outputs.ansible == 'true'
        env:
          PAI_SSH_KEY_FILE: ~/.ssh_key
        run: uv run ansible-playbook ansible/playbooks/deploy-bot.yml

      - name: Cleanup
        if: always()
        run: rm -f ~/.vault_pass_pai ~/.ssh_key
