---
- name: Setup PAI VPS
  hosts: pai-server
  become: yes

  vars:
    app_user: "{{ ansible_user }}"
    home_dir: "/home/{{ app_user }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install system dependencies
      apt:
        name:
          - curl
          - unzip
          - git
          - build-essential
        state: present

    - name: Check if Bun is installed
      stat:
        path: "{{ home_dir }}/.bun/bin/bun"
      register: bun_installed

    - name: Install Bun
      shell: curl -fsSL https://bun.sh/install | bash
      become_user: "{{ app_user }}"
      when: not bun_installed.stat.exists

    - name: Add Bun to PATH in .bashrc
      lineinfile:
        path: "{{ home_dir }}/.bashrc"
        line: 'export PATH="$HOME/.bun/bin:$PATH"'
        state: present
        create: yes
      become_user: "{{ app_user }}"

    - name: Check if Claude Code is installed
      stat:
        path: "{{ home_dir }}/.local/bin/claude"
      register: claude_installed

    - name: Install Claude Code CLI
      shell: curl -fsSL https://claude.ai/install.sh | bash
      become_user: "{{ app_user }}"
      args:
        executable: /bin/bash
      when: not claude_installed.stat.exists

    - name: Add Claude to PATH in .bashrc
      lineinfile:
        path: "{{ home_dir }}/.bashrc"
        line: 'export PATH="$HOME/.local/bin:$PATH"'
        state: present
      become_user: "{{ app_user }}"

    - name: Install pm2 globally via bun
      shell: "{{ home_dir }}/.bun/bin/bun install -g pm2"
      become_user: "{{ app_user }}"
      args:
        creates: "{{ home_dir }}/.bun/bin/pm2"

    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
      loop:
        - "{{ home_dir }}/pai-bot"
        - "{{ home_dir }}/pai-bot/data"
        - "{{ home_dir }}/pai-bot/logs"
        - "{{ home_dir }}/pai-claude"

    - name: Print next steps
      debug:
        msg: |
          VPS setup complete!

          Next steps:
          1. Run: ansible-playbook playbooks/setup-claude-auth.yml
          2. Run: ansible-playbook playbooks/deploy-bot.yml
