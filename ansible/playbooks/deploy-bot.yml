---
- name: Deploy PAI Bot Service
  hosts: pai-server
  vars_files:
    - ../inventory/group_vars/all/vault.yml

  tasks:
    - name: Sync pai-claude source code
      synchronize:
        src: ../../pai-claude/
        dest: "/home/{{ ansible_user }}/pai-claude/"
        delete: yes
        rsync_opts:
          - "--exclude=node_modules/"
          - "--exclude=.git/"

    - name: Sync bot source code
      synchronize:
        src: ../../pai-bot/
        dest: "/home/{{ ansible_user }}/pai-bot/"
        delete: yes
        rsync_opts:
          - "--exclude=node_modules/"
          - "--exclude=.env"
          - "--exclude=data/"
          - "--exclude=logs/"

    - name: Fix ownership of synced files
      file:
        path: "/home/{{ ansible_user }}/{{ item }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: yes
      loop:
        - pai-bot
        - pai-claude

    - name: Ensure logs directory exists
      file:
        path: "/home/{{ ansible_user }}/pai-bot/logs"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Create .env file
      template:
        src: templates/bot.env.j2
        dest: "/home/{{ ansible_user }}/pai-bot/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"

    - name: Install dependencies
      shell: |
        source ~/.bashrc
        cd ~/pai-bot
        ~/.bun/bin/bun install
      become_user: "{{ ansible_user }}"
      args:
        executable: /bin/bash

    - name: Initialize database
      shell: |
        source ~/.bashrc
        cd ~/pai-bot
        ~/.bun/bin/bun run db:init
      become_user: "{{ ansible_user }}"
      args:
        executable: /bin/bash
        creates: "/home/{{ ansible_user }}/pai-bot/data/pai.db"

    - name: Install systemd service
      template:
        src: templates/pai-bot.service.j2
        dest: /etc/systemd/system/pai-bot.service
        mode: "0644"

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable and start pai-bot service
      systemd:
        name: pai-bot
        enabled: yes
        state: restarted

    - name: Wait for service to start
      pause:
        seconds: 3

    - name: Check service status
      shell: systemctl status pai-bot --no-pager
      register: service_status
      ignore_errors: yes

    - name: Print service status
      debug:
        var: service_status.stdout_lines
