---
- name: Deploy PAI Bot Service
  hosts: pai-server
  vars_files:
    - ../inventory/group_vars/all/vault.yml

  tasks:
    - name: Sync bot source code
      ansible.posix.synchronize:
        src: ../../pai-bot/
        dest: "/home/{{ ansible_user }}/pai-bot/"
        delete: true
        rsync_opts:
          - "--exclude=node_modules/"
          - "--exclude=.env"
          - "--exclude=data/"
          - "--exclude=logs/"
      register: bot_sync

    - name: Fix ownership of synced files
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/pai-bot"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: true

    - name: Ensure logs directory exists
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/pai-bot/logs"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Create .env file
      ansible.builtin.template:
        src: templates/bot.env.j2
        dest: "/home/{{ ansible_user }}/pai-bot/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"

    - name: Check if node_modules exists
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/pai-bot/node_modules"
      register: node_modules_stat

    - name: Get remote lockfile hash
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/pai-bot/bun.lock"
        checksum_algorithm: sha256
      register: remote_lockfile

    - name: Get local lockfile hash
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../../pai-bot/bun.lock"
        checksum_algorithm: sha256
      delegate_to: localhost
      become: false
      register: local_lockfile

    - name: Install dependencies
      ansible.builtin.shell: |
        source ~/.bashrc
        cd ~/pai-bot
        ~/.bun/bin/bun install --frozen-lockfile
      become: true
      become_user: "{{ ansible_user }}"
      args:
        executable: /bin/bash
      when: >
        not node_modules_stat.stat.exists or
        (local_lockfile.stat.checksum | default('') != remote_lockfile.stat.checksum | default(''))
      changed_when: true

    - name: Initialize database
      ansible.builtin.shell: |
        source ~/.bashrc
        cd ~/pai-bot
        ~/.bun/bin/bun run db:init
      become: true
      become_user: "{{ ansible_user }}"
      args:
        executable: /bin/bash
        creates: "/home/{{ ansible_user }}/pai-bot/data/pai.db"

    - name: Install systemd service
      ansible.builtin.template:
        src: templates/pai-bot.service.j2
        dest: /etc/systemd/system/pai-bot.service
        mode: "0644"

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable and start pai-bot service
      ansible.builtin.systemd:
        name: pai-bot
        enabled: true
        state: restarted

    - name: Wait for service to start
      ansible.builtin.pause:
        seconds: 3

    - name: Check service status
      ansible.builtin.command: systemctl status pai-bot --no-pager
      register: service_status
      ignore_errors: true
      changed_when: false

    - name: Print service status
      ansible.builtin.debug:
        var: service_status.stdout_lines
