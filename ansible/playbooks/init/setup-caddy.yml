---
# 設定 Caddy Web Server（自動 HTTPS）
# 用法: ./scripts/ansible-wrapper.sh ansible-playbook -i inventory playbooks/init/setup-caddy.yml

- name: Setup Caddy for static site with automatic HTTPS
  hosts: pai-server
  become: true
  vars_files:
    - ../../inventory/group_vars/all/vault.yml

  vars:
    domain: "{{ vault_site_domain }}"
    webroot: /home/pai/merlin/workspace/site

  tasks:
    - name: Stop and disable nginx if exists
      ansible.builtin.systemd:
        name: nginx
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Install dependencies
      ansible.builtin.apt:
        name:
          - debian-keyring
          - debian-archive-keyring
          - apt-transport-https
          - curl
        state: present
        update_cache: true

    - name: Add Caddy GPG key
      ansible.builtin.shell: |
        curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg

    - name: Add Caddy repository
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/caddy-stable.list
        content: |
          deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main
          deb-src [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main
        mode: "0644"

    - name: Install Caddy
      ansible.builtin.apt:
        name: caddy
        state: present
        update_cache: true

    - name: Ensure webroot directory exists with correct permissions
      ansible.builtin.file:
        path: "{{ webroot }}"
        state: directory
        owner: pai
        group: pai
        mode: "0755"

    - name: Add caddy user to pai group for read access
      ansible.builtin.user:
        name: caddy
        groups: pai
        append: true

    - name: Ensure conf.d directory exists
      ansible.builtin.file:
        path: /etc/caddy/conf.d
        state: directory
        mode: "0755"

    - name: Configure Caddyfile
      ansible.builtin.copy:
        dest: /etc/caddy/Caddyfile
        content: |
          import /etc/caddy/conf.d/*.caddy

          {{ domain }} {
              root * {{ webroot }}
              file_server

              header {
                  X-Frame-Options "SAMEORIGIN"
                  X-Content-Type-Options "nosniff"
              }
          }
        mode: "0644"
        owner: root
        group: root
      notify: Reload caddy

    - name: Start and enable Caddy
      ansible.builtin.systemd:
        name: caddy
        state: started
        enabled: true

  handlers:
    - name: Reload caddy
      ansible.builtin.systemd:
        name: caddy
        state: reloaded
