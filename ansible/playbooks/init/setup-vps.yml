---
- name: Setup PAI VPS
  hosts: pai-server
  become: true

  vars:
    app_user: "{{ ansible_user }}"
    home_dir: "/home/{{ app_user }}"

  vars_files:
    - ../../inventory/group_vars/all/vault.yml

  tasks:
    - name: Install ufw
      ansible.builtin.apt:
        name: ufw
        state: present

    - name: Configure firewall - allow SSH
      community.general.ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Configure firewall - allow HTTP
      community.general.ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Configure firewall - allow HTTPS
      community.general.ufw:
        rule: allow
        port: "443"
        proto: tcp

    - name: Enable firewall
      community.general.ufw:
        state: enabled
        policy: deny

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install system dependencies
      ansible.builtin.apt:
        name:
          - curl
          - unzip
          - git
          - build-essential
        state: present

    - name: Check if Bun is installed
      ansible.builtin.stat:
        path: "{{ home_dir }}/.bun/bin/bun"
      register: bun_installed

    - name: Install Bun
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          curl -fsSL https://bun.sh/install | bash
        executable: /bin/bash
      become: true
      become_user: "{{ app_user }}"
      when: not bun_installed.stat.exists
      changed_when: true

    - name: Add Bun to PATH in .bashrc
      ansible.builtin.lineinfile:
        path: "{{ home_dir }}/.bashrc"
        line: 'export PATH="$HOME/.bun/bin:$PATH"'
        state: present
        create: true
        mode: "0644"
      become: true
      become_user: "{{ app_user }}"

    - name: Check if Claude Code is installed
      ansible.builtin.stat:
        path: "{{ home_dir }}/.local/bin/claude"
      register: claude_installed

    - name: Install Claude Code CLI
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          curl -fsSL https://claude.ai/install.sh | bash
        executable: /bin/bash
      become: true
      become_user: "{{ app_user }}"
      when: not claude_installed.stat.exists
      changed_when: true

    - name: Add Claude to PATH in .bashrc
      ansible.builtin.lineinfile:
        path: "{{ home_dir }}/.bashrc"
        line: 'export PATH="$HOME/.local/bin:$PATH"'
        state: present
      become: true
      become_user: "{{ app_user }}"

    - name: Schedule daily Claude Code update
      ansible.builtin.cron:
        name: "Update Claude Code"
        minute: "0"
        hour: "3"
        job: "{{ home_dir }}/.local/bin/claude update > /dev/null 2>&1"
        user: "{{ app_user }}"

    - name: Install pm2 globally via bun
      ansible.builtin.command:
        cmd: "{{ home_dir }}/.bun/bin/bun install -g pm2"
        creates: "{{ home_dir }}/.bun/bin/pm2"
      become: true
      become_user: "{{ app_user }}"

    - name: Configure sudoers for MCP system tools
      ansible.builtin.copy:
        dest: /etc/sudoers.d/pai-mcp
        content: |
          # Allow pai user to manage services without password
          pai ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload caddy
          pai ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart pai-bot
        mode: "0440"
        validate: /usr/sbin/visudo -cf %s

    - name: Download GitHub CLI apt key
      ansible.builtin.get_url:
        url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
        dest: /usr/share/keyrings/githubcli-archive-keyring.gpg
        mode: "0644"

    - name: Add GitHub CLI repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        state: present
        filename: github-cli

    - name: Install GitHub CLI
      ansible.builtin.apt:
        name: gh
        state: present
        update_cache: true

    - name: Configure git user name
      community.general.git_config:
        name: user.name
        value: Merlin
        scope: global
      become: true
      become_user: "{{ app_user }}"

    - name: Configure git user email
      community.general.git_config:
        name: user.email
        value: merlin@pai.local
        scope: global
      become: true
      become_user: "{{ app_user }}"

    - name: Authenticate GitHub CLI
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          echo "{{ github_token }}" | gh auth login --with-token
        executable: /bin/bash
      become: true
      become_user: "{{ app_user }}"
      no_log: true
      changed_when: true

    - name: Create application directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
      loop:
        - "{{ home_dir }}/pai-bot"
        - "{{ home_dir }}/pai-bot/data"
        - "{{ home_dir }}/pai-bot/logs"
        - "{{ home_dir }}/merlin"
        - "{{ home_dir }}/merlin/workspace"
        - "{{ home_dir }}/merlin/workspace/site"
        - "{{ home_dir }}/merlin/workspace/projects"
        - "{{ home_dir }}/merlin/workspace/scripts"
        - "{{ home_dir }}/merlin/workspace/tools"
        - "{{ home_dir }}/merlin/workspace/data"

    - name: Print next steps
      ansible.builtin.debug:
        msg: |
          VPS setup complete!

          Next steps:
          1. Run: ansible-playbook playbooks/setup-claude-auth.yml
          2. Run: ansible-playbook playbooks/deploy-bot.yml
