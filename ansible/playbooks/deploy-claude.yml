---
# 部署 Claude 配置到 VPS
# - 若啟用 mutagen 同步，只部署非同步的檔案（MCP 配置等）
# - 若未啟用 mutagen，部署全部檔案
# 用法: uv run pai ansible ansible-playbook ansible/playbooks/deploy-claude.yml
- name: Deploy Claude Configuration
  hosts: pai-server

  vars_files:
    - ../inventory/group_vars/all/vault.yml

  vars:
    # 基礎排除項目（Claude 內部目錄和本地設定）
    base_excludes:
      - "--exclude=projects/"
      - "--exclude=todos/"
      - "--exclude=statsig/"
      - "--exclude=debug/"
      - "--exclude=shell-snapshots/"
      - "--exclude=settings.json"
      - "--exclude=settings.local.json"
      - "--exclude=.mcp.json"
      - "--exclude=.credentials.json"
      - "--exclude=credentials.json"
      - "--exclude=node_modules/"
      - "--exclude=bun.lock"
      - "--exclude=*.db"

    # Mutagen 同步的目錄（啟用 mutagen 時額外排除）
    mutagen_excludes:
      - "--exclude=CLAUDE.md"
      - "--exclude=context/"
      - "--exclude=workspace/"
      - "--exclude=hooks/"
      - "--exclude=scripts/"
      - "--exclude=session-env/"
      - "--exclude=plans/"
      - "--exclude=history/"
      - "--exclude=data/"

  tasks:
    - name: Generate Merlin config from vault
      ansible.builtin.copy:
        dest: "/home/{{ ansible_user }}/merlin/merlin-config.json"
        content: |
          {
            "site_domain": "{{ vault_site_domain }}",
            "site_url": "https://{{ vault_site_domain }}",
            "features": {
              "memory": {{ vault_enable_memory | default(false) | lower }},
              "memory_provider": "{{ vault_memory_provider | default('gemini') }}",
              "transcription": {{ vault_enable_transcription | default(false) | lower }},
              "fabric": {{ vault_enable_fabric | default(false) | lower }}
            }
          }
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Sync Claude configuration
      ansible.posix.synchronize:
        src: ../../pai-claude/
        dest: "/home/{{ ansible_user }}/merlin/"
        delete: false
        rsync_opts: "{{ base_excludes + (mutagen_excludes if vault_use_mutagen_sync | default(false) else []) }}"

    - name: Fix ownership after sync
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/merlin"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: true

    - name: Ensure workspace directories exist
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/merlin/workspace/{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - site
        - projects
        - downloads
        - history/sessions
        - history/learnings
        - history/decisions

    - name: Fix site files permissions for Caddy
      ansible.builtin.shell:
        cmd: find /home/{{ ansible_user }}/merlin/workspace/site -type f -exec chmod 644 {} \;
      changed_when: true

    - name: Verify Claude configuration
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/merlin/CLAUDE.md"
      register: claude_config

    - name: Ensure Caddy conf.d directory exists
      become: true
      ansible.builtin.file:
        path: /etc/caddy/conf.d
        state: directory
        mode: "0755"

    - name: Deploy merlin Caddy config to conf.d
      become: true
      ansible.builtin.copy:
        dest: /etc/caddy/conf.d/merlin.caddy
        content: |
          {{ vault_site_domain }} {
              root * /home/{{ ansible_user }}/merlin/workspace/site
              file_server

              header {
                  X-Frame-Options "SAMEORIGIN"
                  X-Content-Type-Options "nosniff"
              }
          }
        mode: "0644"
      notify: Reload caddy

    - name: Update main Caddyfile to import conf.d
      become: true
      ansible.builtin.copy:
        dest: /etc/caddy/Caddyfile
        content: |
          import /etc/caddy/conf.d/*.caddy
        mode: "0644"
      notify: Reload caddy

    - name: Print deployment status
      ansible.builtin.debug:
        msg: "Claude configuration deployed successfully"
      when: claude_config.stat.exists

  handlers:
    - name: Reload caddy
      become: true
      ansible.builtin.systemd:
        name: caddy
        state: reloaded
