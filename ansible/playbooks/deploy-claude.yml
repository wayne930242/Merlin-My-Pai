---
# 單向部署（備用方案，正常使用 mutagen 雙向同步）
# 用法: ./scripts/ansible-wrapper.sh ansible-playbook -i inventory playbooks/deploy-claude.yml
- name: Deploy Claude Configuration
  hosts: pai-server

  vars_files:
    - ../inventory/group_vars/all/vault.yml

  tasks:
    - name: Generate Merlin config from vault
      ansible.builtin.copy:
        dest: "/home/{{ ansible_user }}/merlin/merlin-config.json"
        content: |
          {
            "site_domain": "{{ vault_site_domain }}",
            "site_url": "https://{{ vault_site_domain }}"
          }
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Sync Claude configuration
      ansible.posix.synchronize:
        src: ../../pai-claude/
        dest: "/home/{{ ansible_user }}/merlin/"
        delete: false
        rsync_opts:
          # Claude 內部目錄
          - "--exclude=projects/"
          - "--exclude=todos/"
          - "--exclude=statsig/"
          - "--exclude=debug/"
          - "--exclude=shell-snapshots/"
          # 本地設定
          - "--exclude=settings.json"
          - "--exclude=settings.local.json"
          - "--exclude=.mcp.json"
          - "--exclude=.credentials"
          - "--exclude=credentials.json"
          # Node
          - "--exclude=node_modules/"
          - "--exclude=bun.lock"
          # 資料庫
          - "--exclude=*.db"
          # Mutagen 同步的目錄（避免重複）
          - "--exclude=workspace/.claude/"

    - name: Fix ownership after sync
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/merlin"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: true

    - name: Ensure workspace directories exist
      ansible.builtin.shell: |
        mkdir -p ~/merlin/workspace/{site,projects,scripts,tools,data,downloads}
      args:
        creates: "/home/{{ ansible_user }}/merlin/workspace/downloads"
      become: true
      become_user: "{{ ansible_user }}"

    - name: Fix site files permissions for Caddy
      ansible.builtin.shell:
        cmd: find /home/{{ ansible_user }}/merlin/workspace/site -type f -exec chmod 644 {} \;
      changed_when: true

    - name: Verify Claude configuration
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/merlin/CLAUDE.md"
      register: claude_config

    - name: Update Caddy config to use new path
      become: true
      ansible.builtin.copy:
        dest: /etc/caddy/Caddyfile
        content: |
          {{ vault_site_domain }} {
              root * /home/{{ ansible_user }}/merlin/workspace/site
              file_server

              header {
                  X-Frame-Options "SAMEORIGIN"
                  X-Content-Type-Options "nosniff"
              }
          }
        mode: "0644"
        owner: root
        group: root
      notify: Reload caddy

    - name: Print deployment status
      ansible.builtin.debug:
        msg: "Claude configuration deployed successfully"
      when: claude_config.stat.exists

  handlers:
    - name: Reload caddy
      become: true
      ansible.builtin.systemd:
        name: caddy
        state: reloaded
